---
title: "flat_traitements_sim2.Rmd empty"
output: html_document
editor_options: 
  chunk_output_type: console
---

```{r development, include=FALSE}
library(testthat)
```

```{r development-load}
# Load already included functions if relevant
pkgload::load_all(export_all = FALSE)
```

# def_periode

```{r development-def_periode}
# Prepare the code of your function here
library(dplyr)
library(lubridate)

data("ex_data_sim2")
ex_data_sim2

periode = "saison"
periode = "annee"

# Year and month
table = ex_data_sim2 %>%
  mutate(data_ymd = ymd(DATE)) %>%
  mutate(year = year(data_ymd),
         month = month(data_ymd))

if (periode == "saison"){
  # Saisons météo
table = table %>%
    mutate(
      periode =
        case_when(
          month %in% c(12, 1, 2) ~ "Hiver",
          month %in% c(3, 4, 5) ~ "Printemps",
          month %in% c(6, 7, 8) ~ "Et\u00E9", # \u00E9 -> é
          month %in% c(9, 10, 11) ~ "Automne",
          .default = "Erreur"
        )
    ) %>%
    mutate(
      annee =
        case_when(
          periode == "Hiver" & month %in% c(1, 2) ~ year,
          periode == "Hiver" & month %in% c(12) ~ year + 1,
          .default = year
        )
    ) 

}else if (periode == "annee"){

# Années
table = table %>%
  mutate(periode = "Ann\u00E9e",
         annee = year)

}

table = table %>% select(-data_ymd, -year, -month)




```

```{r function-def_periode}
#' Définir une période temporelle (année ou saison)
#'
#' À partir d'une table contenant une colonne de dates au format #' AAAAMMJJ (année-mois-jour), cette fonction ajoute deux colonnes :
#' \itemize{
#'   \item `periode` : période temporelle ("Hiver", "Printemps", "Été",
#'   "Automne" ou "Année")
#'   \item `annee` : année associée à la période
#' }
#'
#' Lorsque `periode = "saison"`, les saisons météorologiques sont définies comme suit :
#' \itemize{
#'   \item Hiver : décembre à février
#'   \item Printemps : mars à mai
#'   \item Été : juin à août
#'   \item Automne : septembre à novembre
#' }
#'
#' L'année associée à l'hiver correspond à l'année de janvier/février. Ainsi, décembre 1960 est rattaché à l'hiver 1961.
#' 
#' @param data data.frame. Table avec les données qui doit contenir un colonne représentant la date au format année-mois-jour (AAAAMMJJ).
#' @param date_col Character. Nom de la colonne représentant la date.
#' @param periode Character. saison ou annee.
#'
#' @importFrom assertthat assert_that
#' @importFrom dplyr mutate case_when select
#' @importFrom lubridate ymd month year
#'
#' @return tibble. Table initiale avec 2 colonnes en plus : periode et annee
#'  
#' @export
#'
#' @examples
#' 
def_periode <- function(data, date_col = "DATE", periode = "saison") {
  
  ######################################################################
  # Vérifications
  
  # Vérifier la periode
  assert_that(periode %in% c("saison","annee"),
              msg = "periode doit \u00EAtre saison ou annee.") # \u00EA -> ê
  
  # Vérifier que la colonne existe
  assert_that(date_col %in% names(data),
              msg = paste0("Colonne ", date_col, " non trouv\u00E9e dans le data frame"))

  # Vérifier que les valeurs sont des entiers de 8 chiffres
  dates_vec <- data[[date_col]]
  assert_that(
    all(grepl("^\\d{8}$", as.character(dates_vec))),
    msg = paste0("Toutes les valeurs de la colonne ", date_col, " doivent \u00EAtre au format AAAAMMJJ (8 chiffres)")
  )
  
  ######################################################################
  # Year and month
  
  table = ex_data_sim2 %>%
    mutate(data_ymd = ymd(.data[[date_col]])) %>%
    mutate(year = year(data_ymd),
           month = month(data_ymd))
  
  ######################################################################
  # saison ou annee
  
  # Saisons météo
  if (periode == "saison"){
    table = table %>%
      mutate(periode =
               case_when(month %in% c(12, 1, 2) ~ "Hiver",
                         month %in% c(3, 4, 5) ~ "Printemps",
                         month %in% c(6, 7, 8) ~ "Et\u00E9", # \u00E9 -> é
                         month %in% c(9, 10, 11) ~ "Automne",
                         .default = "Erreur")) %>%
      mutate(annee =
               case_when(periode == "Hiver" & month %in% c(1, 2) ~ year,
                         periode == "Hiver" & month %in% c(12) ~ year + 1,
                         .default = year)) 
    
    # Année 
    }else if (periode == "annee"){
      table = table %>%
        mutate(periode = "Ann\u00E9e",
               annee = year)
      }

table = table %>% select(-data_ymd, -year, -month)

return(table)

}
```

```{r examples-def_periode}

data("ex_data_sim2")

resultat = def_periode(data = ex_data_sim2,
                       date_col = "DATE",
                       periode = "saison")
```

```{r tests-def_periode}
test_that("def_periode works", {
  expect_true(inherits(def_periode, "function"))
})
```


```{r development-inflate, eval=FALSE}
# Run but keep eval=FALSE to avoid infinite loop
# Execute in the console directly
fusen::inflate(flat_file = "dev/flat_traitements_sim2.Rmd", vignette_name = "Traitements des données Météo France SIM2")
```

